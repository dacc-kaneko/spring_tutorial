name: PR Agent Workflow
on:
  pull_request:
    types: [opened, reopened, ready_for_review]
  issue_comment:
    types: [created]
jobs:
  pr_agent_job:
    # ボットによるコメントには反応しない、PRの説明文またはコメントに"[ai-review]"が含まれている場合のみ実行
    # issue_commentの場合はPRに関連するコメントのみ対象とする
    if: ${{ github.event.sender.type != 'Bot' && ((github.event_name == 'pull_request' && contains(github.event.pull_request.body, '[ai-review]')) || (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '[ai-review]'))) }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: write
      id-token: write
    name: Run pr agent on every pull request, respond to user comments
    env: 
      REVIEW_INSTRUCTIONS: >-
        日本語を使用してください。
        以下に記載した観点からレビューを行ってください。
        ただし、改善点がなければ回答は不要です。
        クエリやgormが利用されている場合、以下2つの観点から改善提案してください。
        - クエリそのもののパフォーマンス改善
        - 検索対象テーブルにインデックスを追加すべきカラムがあるか
        その他ファイル対して、以下の観点でレビューしてください。
        - 命名は分かりやすく実態を表しているか
        - typo
        - 可読性
        - セキュリティ上の脆弱性がないか
        - トランザクションの貼り方が適切か
        - nilチェックが適切にされているか
        - 理解しにくい、または実装と命名が乖離している箇所があるか
        - 冗長なコードがないか
        - メソッド名・関数名だけで実装が理解しにくい場合、分かりやすい日本語でコメントされているか
        - ネストが深い（3以上）条件文などがないか
    steps:
      - name: PR Agent action step
        id: pragent
        uses: qodo-ai/pr-agent@main
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          litellm.drop_params: 'true'
          # 出力の詳細度    
          config.verbosity_level: 1 
          # レビューの労力見積もりを必須としない設定です
          pr_reviewer.require_estimate_effort_to_review: 'false'  
          # ファイル要約をインライン表示する設定が有効になっています
          pr_description.inline_file_summary: 'false'  
          # 説明マーカーの使用を無効化しています
          pr_description.use_description_markers: 'false'  
          # 「Generated by」ヘッダーの追加を無効化しています
          pr_description.include_generated_by_header: 'false'  
          # 最終更新メッセージの表示を無効化しています
          pr_description.final_update_message: 'false'  
          # ヘルプテキストの表示を無効化しています
          pr_description.enable_help_text: 'false'  
          # 自動レビュー機能を有効化しています
          github_action_config.auto_review: 'true'  
          # 自動説明生成機能を有効化しています
          github_action_config.auto_describe: 'false'  
          # 自動改善機能を有効化しています
          github_action_config.auto_improve: 'true'  
          # レビュワーには回答を日本語で行うよう指示しています
          pr_reviewer.extra_instructions: ${{ env.REVIEW_INSTRUCTIONS }}
          # コード提案のは回答を日本語で行うよう指示しています
          pr_code_suggestions.extra_instructions: ${{ env.REVIEW_INSTRUCTIONS }}
          # 対応モデルとmax_tokenの参考（https://github.com/qodo-ai/pr-agent/blob/main/pr_agent/algo/__init__.py）
          config.model: gpt-4o-mini
          config.model_turbo: gpt-4o-mini
          config.fallback_models: gpt-3.5-turbo
          config.custom_model_max_tokens: 100000
